---
title: "06_metrics_individual_fragmentomics"
output: html_document
date: "`r Sys.Date()`"
---

```{r}
library(dplyr)
library(matrixStats)
library(ComplexHeatmap)
library(circlize)
library(cowplot)
library(ggpubr)
library(gridExtra)
library(readxl)
library(lubridate)
library(here)
```

```{r setup, include=FALSE}
# set the working directory
knitr::opts_knit$set(root.dir = here::here())
```

```{r}
# Define paths
outdir <- here::here("figures", "statistics")
scores_path <- here::here("data", "statistics", "02_processing_statistics_integrated_cancer_scores.csv")
scores_normal_path <- here::here("data", "statistics", "01_statistics_control_scores.csv")
metadata_path <- here::here("raw_data", "cohort", "HBOC_cohort_metadata.xlsx")

# Ensure output directory exists
if (!dir.exists(outdir)) dir.create(outdir, recursive = TRUE)

# Read in data
scores <- read.csv(scores_path, header = TRUE, check.names = FALSE)
scores_normal <- read.csv(scores_normal_path, header = TRUE, check.names = FALSE)

# Load sample metadata
samples <- readxl::read_excel(metadata_path, sheet = "April22")
samples <- samples[!grepl("-B|-Tumour", samples$group_id), ]
samples <- samples[!grepl("T-788-T0", samples$group_id), ]
samples <- samples[!grepl("T-207-T0", samples$group_id), ]
```

# formatting Time_to_next_positive
```{r}
# Calculate months_to_positive
samples$months_to_positive <- ifelse(
  samples$cancer_status == "positive", 
  "positive",  # Assign "positive" for positive cases
  ifelse(
    samples$Time_to_next_positive %in% c("no_future_cancer", "UNK", "pending"), 
    samples$Time_to_next_positive,  # Keep special cases as is
    as.numeric(interval(ymd(samples$date_of_blood), ymd(samples$Time_to_next_positive_dates)) / months(1)) # Calculate months
  )
)

# Ensure calculated months are numeric where applicable, retaining special cases as strings
samples$months_to_positive <- ifelse(
  samples$months_to_positive %in% c("no_future_cancer", "UNK", "pending", "positive"),
  samples$months_to_positive,  # Keep as is for special cases and "positive"
  as.numeric(samples$months_to_positive) # Convert calculated values to numeric
)
```

```{r}
samples <- samples[, c("group_id", "Library Name", "TS", "source", "cancer_type", "survivor", "months_to_positive")]
```

```{r}
# Exclusions (same ones you had)
ban_group <- c("T-788-T0","T-207-T0","LIB-04-0649-T0",
               "LIB-04-0441-T1","LIB-04-0024-T2","LIB-04-0131-T0")
ban_ts_wgs <- c("TGL49_0085_Cf_U_PE_4150_WG",
                "TGL49_0291_Pl_T_PE_405_PG",
                "TGL49_0293_Pl_T_PE_385_PG",
                "TGL49_0252_Cf_n_PE_1110_WG")

# Remove unwanted samples **before merge**
samples <- samples[!(samples$group_id %in% ban_group), ]
scores  <- scores[ !(scores$group_id %in% ban_group), ]

# Clean `TS` in both data frames
samples$TS[samples$TS %in% ban_ts_wgs] <- NA
scores$TS[scores$TS %in% ban_ts_wgs]   <- NA

# --- Merge ---
# If you want to KEEP all samples (and still bring in matching scores):
data <- merge(samples, scores, by = c("group_id", "Library Name", "TS"), all.x = TRUE)

# --- Check ---
# table(is.na(data$TS))        # see if any missing TS remain
# table(is.na(data$source))    # source should be NA only for unmatched rows

``` 


```{r}
sites <- c("OV", "BRCA", "PRAD", "LUAD", "BLCA", "LGG", "ACC", "CESC", "CHOL", "COAD", "ESCA", "GBM", "HNSC", 
  "KIRC", "KIRP", "LIHC", "LUSC", "MESO", "PCPG", "SKCM", "STAD", "TGCT", "THCA", "UCEC")

names <- c("Ovarian Cancer", "Breast Cancer", "Prostate Cancer", "Lung Adenocarcinoma", "Bladder Cancer", 
  "Brain Lower Grade Glioma", "Adrenocortical Carcinoma", "Cervical and Endocervical Cancer", 
  "Cholangiocarcinoma", "Colon Cancer", "Esophageal Cancer", "Glioblastoma", "Head and Neck Cancer", 
  "Kidney Clear Cell Carcinoma", "Kidney Papillary Cell Carcinoma", "Liver Cancer", 
  "Lung Squamous Cell Carcinoma", "Mesothelioma", "Pheochromocytoma and Paraganglioma", "Melanoma", 
  "Stomach Cancer", "Testicular Germ Cell Tumors", "Thyroid Cancer", "Uterine Endometrial Cancer")

lists <- c("ovarian", "breast", "prostate", "lung_adenocarcinoma", "bladder", "brain", "adrenocortical", 
  "cervical_endocervical", "cholangiocarcinoma", "colon", "esophageal", "glioblastoma", "head_neck", 
  "kidney_clear_cell", "kidney_papillary_cell", "liver", "lung_squamous_cell", "mesothelioma", 
  "pheochromocytoma_paraganglioma", "melanoma", "stomach", "testicular_germ_cell", "thyroid", "uterine_endometrial")

```

# Process griffin scores to combine to one column 
```{r}
zscore_cols <- grep("^AverageZScore_", colnames(scores_normal), value = TRUE)

griffin_cutoffs <- sapply(zscore_cols, function(col) {
  quantile(scores_normal[[col]], 0.01, na.rm = TRUE)
})
names(griffin_cutoffs) <- gsub("^AverageZScore_", "AverageZScore_", zscore_cols)

for (col in names(griffin_cutoffs)) {
  #print(col)
  if (col %in% colnames(data)) {
    cutoff <- griffin_cutoffs[col]
    data[[col]] <- ifelse(data[[col]] < cutoff, "pos", "neg")
    data[[col]][is.na(data$`Library Name`) | data$`Library Name` == ""] <- "NS"
  }
}

# Consensus griffin: "pos" if 5 or more sites are "pos"
# Count the number of "pos" across all z-score columns for each row
data$consensus_griffin <- apply(data[, zscore_cols], 1, function(row) {
  sum(row == "pos", na.rm = TRUE)
})
```


```{r}
nucleosome_peak_cutoff <- quantile(scores_normal$avg_zscore_nuc_peaks, 0.99, na.rm = TRUE)
tumour_fraction_cutoff <- quantile(scores_normal$Tumour.Fraction , 0.99, na.rm = TRUE)
#tumour_fraction_cutoff <- .1
fragment_ratio_cutoff <- quantile(scores_normal$fragment_ratio_corr , 0.01, na.rm = TRUE)
fragment_length_cutoff <- quantile(scores_normal$FS , 0.99, na.rm = TRUE)
consensus_griffin_cutoff <- 1 
integrated_ctDNA_score_cutoff <- 0.5 
```


```{r}
# Define valid samples (Library Name not NA or empty)
valid_samples <- data[!is.na(data$`Library Name`) & data$`Library Name` != "", ]

# Remove samples with months_to_positive == "UNK" or "pending"
#valid_samples <- valid_samples[!valid_samples$months_to_positive %in% c("UNK", "pending"), ]
```

```{r}
table(valid_samples$source)
```

```{r}
summarize_ctdna_metric <- function(samples, metric_col, is_positive_fn, label) {
  # Helper to get mode
  get_mode <- function(v) {
    uniqv <- unique(v)
    uniqv[which.max(tabulate(match(v, v)))]
  }

  # Filter out NA metric values
  valid_samples <- samples[!is.na(samples[[metric_col]]), ]
  positive_samples <- valid_samples[is_positive_fn(valid_samples[[metric_col]]), ]
  # Remove rows full of NA
  positive_samples <- positive_samples[rowSums(!is.na(positive_samples)) > 0, ]

  total_valid  <- nrow(valid_samples)
  count_pos    <- nrow(positive_samples)
  percent_pos  <- round(100 * count_pos / total_valid, 1)

  cat("\n==========", label, "==========\n")
  cat("Total valid (non-NA):", total_valid, "\n",
      "Positives:", count_pos, sprintf("(%.1f%%)\n", percent_pos))

  # --- Overall summary of metric ---
  vals_all <- valid_samples[[metric_col]]
  cat("\nOverall summary of", metric_col, ":\n")
  cat(
    " Mean:",   round(mean(vals_all, na.rm=TRUE), 2),
    " SD:",     round(sd(vals_all,   na.rm=TRUE), 2),
    " Min:",    round(min(vals_all,  na.rm=TRUE), 2),
    " 25th%:",  round(quantile(vals_all, .25, na.rm=TRUE), 2),
    " Median:", round(median(vals_all, na.rm=TRUE), 2),
    " 75th%:",  round(quantile(vals_all, .75, na.rm=TRUE), 2),
    " Max:",    round(max(vals_all,  na.rm=TRUE), 2), "\n"
  )

  # --- Breakdown of positive samples by cancer_status ---
  cat("\nBy cancer_status (positive samples):\n")
  cs_tab <- table(positive_samples$cancer_status)
  print(cs_tab); print(round(prop.table(cs_tab)*100,1))

  # --- Breakdown of positive samples by source ---
  cat("\nBy source (positive samples):\n")
  src_tab <- table(positive_samples$source)
  print(src_tab); print(round(prop.table(src_tab)*100,1))

  # --- Unique LIB_IDs ---
  cat("\nUnique LIB_IDs (positive):", length(unique(positive_samples$LIB_ID)), "\n")

  # --- Negative vs positive breakdown ---
  neg_all <- valid_samples$cancer_status == "negative"
  pos_all <- valid_samples$cancer_status == "positive"
  neg_pos <- sum(positive_samples$cancer_status == "negative", na.rm=TRUE)
  pos_pos <- sum(positive_samples$cancer_status == "positive", na.rm=TRUE)
  cat(
    "\nCancer-negative:", sum(neg_all), "-> positive:", neg_pos,
    sprintf("(%.1f%%)\n", 100*neg_pos/sum(neg_all)),
    "Cancer-positive:", sum(pos_all), "-> positive:", pos_pos,
    sprintf("(%.1f%%)\n", 100*pos_pos/sum(pos_all))
  )

  # --- Future-cancer in cancer-negative positives ---
  neg_samps   <- positive_samples[positive_samples$cancer_status == "negative", ]
  months_num  <- suppressWarnings(as.numeric(neg_samps$months_to_positive))
  unk_pend    <- sum(neg_samps$months_to_positive %in% c("UNK", "pending"))
  fut_idx     <- !is.na(months_num)
  fut_all     <- sum(fut_idx)
  fut_12      <- sum(months_num < 12, na.rm=TRUE)
  max_months  <- if (fut_all > 0) round(max(months_num[fut_idx], na.rm=TRUE), 1) else NA
  mean_months <- if (fut_all > 0) round(mean(months_num[fut_idx], na.rm=TRUE), 1) else NA
  med_months  <- if (fut_all > 0) round(median(months_num[fut_idx], na.rm=TRUE), 1) else NA

  cat(
    "\nNeg-pos total:", nrow(neg_samps), "\n",
    " UNK/pending:", unk_pend, sprintf("(%.1f%%)\n", 100*unk_pend/nrow(neg_samps)),
    " Future cancer (>0):", fut_all, sprintf("(%.1f%%)\n", 100*fut_all/nrow(neg_samps)),
    " <12 mo:", fut_12, sprintf("(%.1f%%)\n", 100*fut_12/nrow(neg_samps)),
    " Max months:", max_months, " Mean months:", mean_months,
    " Median months:", med_months, "\n"
  )

  # --- Summary stats by source ---
  cat("\nSummary by source:\n")
  by_src <- split(valid_samples[[metric_col]], valid_samples$source)
  for (s in names(by_src)) {
    v <- by_src[[s]]
    cat(
      " Source:", s,
      " Mean:",   round(mean(v, na.rm=TRUE), 2),
      " Median:", round(median(v, na.rm=TRUE), 2),
      " SD:",     round(sd(v,   na.rm=TRUE), 2),
      " Min:",    round(min(v,  na.rm=TRUE), 2),
      " Max:",    round(max(v,  na.rm=TRUE), 2),
      " Range:",  paste0("[", round(min(v, na.rm=TRUE),2), ", ", round(max(v, na.rm=TRUE),2), "]"),
      " IQR:",    round(IQR(v, na.rm=TRUE), 2), "\n"
    )
  }

  # --- Summary stats by cancer_status ---
  cat("\nSummary by cancer_status:\n")
  by_stat <- split(valid_samples[[metric_col]], valid_samples$cancer_status)
  for (st in names(by_stat)) {
    v <- by_stat[[st]]
    cat(
      " Status:", st,
      " Mean:",   round(mean(v,   na.rm=TRUE), 2),
      " Median:", round(median(v, na.rm=TRUE), 2),
      " SD:",     round(sd(v,     na.rm=TRUE), 2),
      " Min:",    round(min(v,    na.rm=TRUE), 2),
      " Max:",    round(max(v,    na.rm=TRUE), 2),
      " Range:",  paste0("[", round(min(v, na.rm=TRUE),2), ", ", round(max(v, na.rm=TRUE),2), "]"),
      " IQR:",    round(IQR(v,     na.rm=TRUE), 2), "\n"
    )
  }
}
```

```{r}
summarize_ctdna_metric(
  valid_samples,
  "integrated_ctDNA_score",
  function(x) !is.na(x) & x >= integrated_ctDNA_score_cutoff,
  "Integrated ctDNA Score (>= 0.5)"
)
```

```{r}
# Run summaries for each metric
summarize_ctdna_metric(
  valid_samples,
  "avg_zscore_nuc_peaks",
  function(x) !is.na(x) & x > nucleosome_peak_cutoff,
  "Nucleosome Peaks (Z-score > 99th percentile)"
)
```

```{r}
summarize_ctdna_metric(
  valid_samples,
  "fragment_ratio_corr",
  function(x) !is.na(x) & x < fragment_ratio_cutoff,
  "Fragment Ratio (Corr < 1st percentile)"
)
```

```{r}
summarize_ctdna_metric(
  valid_samples,
  "FS",
  function(x) !is.na(x) & x > fragment_length_cutoff,
  "Fragment Length (FS < 99th percentile)"
)
```

```{r}
summarize_ctdna_metric(
  valid_samples,
  "consensus_griffin",
  function(x) !is.na(x) & x >= consensus_griffin_cutoff,
  "Consensus GRIFFIN Score (>= 1)"
)
```

```{r}
# Run summaries for each metric
summarize_ctdna_metric(
  valid_samples,
  "Tumour.Fraction",
  function(x) !is.na(x) & x > tumour_fraction_cutoff,
  "Tumour Fraction (TF > 99th percentile)"
)

```
