---
title: "10_processing_statistics_final_scoring_analysis"
output: html_document
date: "2025-03-20"
---

```{r setup, include=FALSE}
# set the working directory
knitr::opts_knit$set(root.dir = "/Users/erikensminger/Library/CloudStorage/OneDrive-UniversityofToronto/EarlyDetectionHBOC")
```


```{r}
library(tidyverse)
library(dplyr)
library(reshape2)
library(ggformula)
library(signal)
library(matrixStats)
library(lemon)
library(ggpubr)
library(data.table)
library(readxl)
```

```{r}
# outdir <- "./figures"
outdir <- "./data/metrics/DNA_extraction"

scores_normal_path <- "./data/statistics/03_statistics_control_scores_2025-03-04.csv"
scores_normal <- read.csv(scores_normal_path, header=TRUE, check.names=FALSE)
scores_normal <- scores_normal$Sample

DNA_ext_path <- "./raw_data/DNA_extraction/Erik-Yield-Request-2025-02-28.xlsx"
DNA_ext <- read_excel(DNA_ext_path)

HCC_healthy_path <- "./raw_data/DNA_extraction/Healthy Controls Processing Log.xlsx"
HCC_healthy_ext <- read_excel(HCC_healthy_path, sheet="cfDNA")

CHARM_sample_ext_path <- "./raw_data/DNA_extraction/HBC_Processing Log.xlsx"
CHARM_sample_ext <- read_excel(CHARM_sample_ext_path, sheet="cfDNA")

CHARM_sample_tracker_path <- "./raw_data/DNA_extraction/CHARM Sample Tracker.xlsx"
CHARM_sample_tracker <- read_excel(CHARM_sample_tracker_path, sheet="HBC")
CHARM_sample_tracker <- CHARM_sample_tracker[, c("sWGS", "LIB_ID", "timepoint")]
```

```{r}
CHARM_sample_tracker$group_id <- paste0(CHARM_sample_tracker$LIB_ID, "-T", CHARM_sample_tracker$timepoint)
CHARM_sample_tracker$sWGS[CHARM_sample_tracker$sWGS %in% scores_normal]
```

```{r}
missing_samples <- scores_normal[!scores_normal %in% CHARM_sample_tracker$sWGS]
# Convert missing_samples to dataframe
missing_samples_df <- data.frame(missing_samples)

# Export missing_samples
write.csv(missing_samples_df, "/Users/erikensminger/Desktop/missing_samples.csv", row.names = FALSE)

missing_samples
```

```{r}
CHARM_sample_tracker <- CHARM_sample_tracker[CHARM_sample_tracker$sWGS %in% scores_normal, ]
```

```{r}
# Add HCC-### column
HCC_healthy_ext$HCC_ID <- paste0("HCC-", sprintf("%03d", HCC_healthy_ext$`#`))
HCC_healthy_ext <- HCC_healthy_ext[, c("HCC_ID", setdiff(names(HCC_healthy_ext), "HCC_ID"))]

# Step 1: Extract numeric codes from scores_normal
scores_normal_num <- sub("HCC-", "", scores_normal)  # removes "HCC-"

# Step 2: Convert to numeric (optional but recommended if HCC_healthy_ext$`#` is numeric)
scores_normal_num <- as.numeric(scores_normal_num)

# Step 3: Subset HCC_healthy_ext where # is in the extracted numbers
HCC_healthy_ext_subset <- HCC_healthy_ext[HCC_healthy_ext$`#` %in% scores_normal_num, ]
```

```{r}
# Export HCC_healthy_ext_subset
write.csv(HCC_healthy_ext_subset, "/Users/erikensminger/Desktop/HCC_healthy_ext_subset.csv", row.names = FALSE)

# Export CHARM_sample_tracker
write.csv(CHARM_sample_tracker, "/Users/erikensminger/Desktop/CHARM_sample_tracker_filtered.csv", row.names = FALSE)
```