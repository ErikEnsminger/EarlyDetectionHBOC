---
title: "cohort_plot"
output: html_document
date: "2024-10-31"
---

```{r setup, include=FALSE}
# set the working directory
knitr::opts_knit$set(root.dir = "/Users/erikensminger/Library/CloudStorage/OneDrive-UniversityofToronto/EarlyDetectionHBOC")
```


```{r}
library(tidyverse)
library(ggpubr)
library(readxl)
library(dplyr)
```

```{r}

outdir <- "./figures/cohort"
metadata_path <- "/Users/erikensminger/Library/CloudStorage/OneDrive-UniversityofToronto/HBOC_cohort_metadata.xlsx" 
metadata <- read_excel(metadata_path, sheet="April22")
```

```{r}
# drop the rows with timepoint buffy 
metadata <- metadata[!(metadata$timepoint %in% c("buffy", "tumour")) & !(is.na(metadata$`Library Name`) & is.na(metadata$TS)), ]

# remove WGS samples that were don't have TS done - we just used to verify germline mutatation
metadata$TS[metadata$TS == "TGL49_0085_Cf_U_PE_4150_WG"] <- ""
metadata$TS[metadata$TS == "TGL49_0291_Pl_T_PE_405_PG"] <- ""
metadata$TS[metadata$TS == "TGL49_0293_Pl_T_PE_385_PG"] <- ""
metadata$TS[metadata$TS == "TGL49_0252_Cf_n_PE_1110_WG"] <- ""

metadata <- metadata[!grepl("T-788-T0", metadata$group_id), ]
metadata <- metadata[!grepl("T-207-T0", metadata$group_id), ]

```

```{r}
# ### Find latest timepoint
# latest_timepoint <- metadata %>%
#   group_by(LIB_ID) %>%
#   dplyr::summarise(last = max(date_of_blood),
#                    n = n())
# latest <- rep(latest_timepoint$last, latest_timepoint$n)
# metadata$last <- latest
```


```{r}
# Find baseline timepoint based on first positive sample or first date_of_blood if none are positive
baseline_timepoint <- metadata %>%
  group_by(LIB_ID) %>%
  summarise(
    baseline = if (any(cancer_status == "positive")) {
      min(date_of_blood[cancer_status == "positive"])
    } else {
      min(date_of_blood)
    },
    n = n()
  )

# Repeat baseline dates across rows to add as a new column
baseline_dates <- rep(baseline_timepoint$baseline, baseline_timepoint$n)
metadata$baseline <- baseline_dates
```

```{r}
# Calculate time_from_baseline in months
metadata <- metadata %>%
  mutate(
    time_from_baseline = as.numeric(difftime(date_of_blood, baseline, units = "days")) / 30.44  # Average days per month
  )
```

```{r}
data_sero <- distinct(metadata, LIB_ID, cancer_status, .keep_all= TRUE)
homo_sero <- data_sero[!(data_sero$LIB_ID %in% data_sero$LIB_ID[duplicated(data_sero$LIB_ID)]), ]

```

```{r}
# all_negative <- homo_sero$LIB)[homo_sero$cancer_status == "negative"]
# all_positive <- homo_sero$ext_ID[homo_sero$cancer_status == "positive"]
```


```{r}

library(dplyr)
library(dplyr)

# Step 1: Classify each LIB_ID including single timepoint cases
data_sero <- data_sero %>%
  group_by(LIB_ID) %>%
  arrange(timepoint) %>%
  summarise(
    converter = case_when(
      # Forward Phenoconverter: transition from negative to positive
      n() > 1 & any(cancer_status == "negative" & lead(cancer_status) == "positive") ~ "Forward Phenoconverters",
      # Reverse Phenoconverter: transition from positive to negative
      n() > 1 & any(cancer_status == "positive" & lead(cancer_status) == "negative") ~ "Reverse Phenoconverters",
      # Active Cancer: positive throughout or single positive timepoint
      all(cancer_status == "positive") ~ "Active Cancer",
      # Cancer Free: negative throughout or single negative timepoint
      all(cancer_status == "negative") ~ "Cancer Free",
      # Multiple Cancers: has a mix of positive and negative without straightforward conversion
      TRUE ~ "Multiple Cancers"
    )
  )

# Step 2: Set factor levels for ordered categories
data_sero$converter <- factor(data_sero$converter, levels = c(
  "Multiple Cancers", "Forward Phenoconverters", "Reverse Phenoconverters", "Active Cancer", "Cancer Free"
))
```

```{r}
# Merge the converter classification back to metadata
metadata <- metadata %>%
  left_join(data_sero, by = "LIB_ID")

```

```{r}
library(dplyr)

# Add a new column based on the presence of "Library Name" and "TS"
metadata <- metadata %>%
  mutate(
    data_type = case_when(
      !is.na(`Library Name`) & !is.na(TS) ~ "WGS and TS",
      !is.na(`Library Name`) & is.na(TS) ~ "only WGS",
      is.na(`Library Name`) & !is.na(TS) ~ "only TS",
      TRUE ~ NA_character_
    )
  )

# Convert the new column to a factor with specified levels
metadata$data_type <- factor(metadata$data_type, levels = c("WGS and TS", "only WGS", "only TS"))
```

```{r}
# Order LIB_ID based on the number of samples per LIB_ID
# Step 1: Calculate the number of samples per LIB_ID and sort by count
sample_counts <- metadata %>%
  group_by(LIB_ID) %>%
  summarise(n = n()) %>%
  arrange(n)

# Step 2: Use the sorted LIB_ID order as levels in metadata
ordered_LIB_IDs <- sample_counts$LIB_ID
metadata$LIB_ID <- factor(metadata$LIB_ID, levels = ordered_LIB_IDs)
```

```{r}
### Plot data
theme <- theme(
    plot.title = element_text(hjust = 0, face = "bold", size = 20),  # Smaller title
    axis.line = element_line(colour = "black", linewidth = 0.5),      # Thinner axis line
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    strip.background = element_rect(fill = NA),
    strip.text = element_text(size = 15),                             # Smaller facet labels
    strip.text.y = element_text(angle = 0, size = 20, face = "bold",),
    legend.justification = c("left", "bottom"),
    legend.key = element_blank(),                                     # Keep blank legend keys
    legend.text = element_text(size = 20),                            # Smaller legend text
    legend.title = element_text(size = 25),                           # Smaller legend title
    axis.text = element_text(size = 20),                              # Smaller axis text
    #axis.text.y = element_text(size = 15),                            # Smaller y-axis labels
    axis.text.y = element_blank(),    
    axis.title = element_text(size = 25),                             # Smaller axis titles
    axis.title.x = element_text(size = 25, vjust = -1),
    plot.margin = margin(10, 20, 20, 20),                               # Adjusted plot margins
    panel.spacing.y = unit(1.5, "lines")                              # Slightly reduced panel spacing
)

```


```{r}
# Plot data with data_type as shape
plot_pheno_status <- ggplot(metadata, aes(time_from_baseline, LIB_ID, group = LIB_ID, color = cancer_status, shape = data_type)) + 
  geom_line(color = "grey", size = 1) +        # Thinner line
  geom_point(size = 4, stroke = 1.5) +         # Smaller points
  ggtitle("HBOC: Overview of Cancer Status and Sequencing Availability") +
  xlab("Months from Baseline") +
  ylab("Patient") +
  labs(color = "Cancer Status", shape = "Sequencing Type Available") +
  scale_color_manual(values = c("black", "red")) +
  scale_shape_manual(values = c(16, 0, 4)) +
  facet_grid(converter ~ ., scales = "free_y", space = "free_y") +
  theme

  
plot_pheno_status
```

```{r}
# Save plot with reduced dimensions
ggsave(file.path(outdir, "02_figure_cohort_timelines_by_converters.pdf"), 
       plot_pheno_status, width = 20, height = 20)
```


### grouping by source 
```{r}
# Plot data with data_type as shape
plot_pheno_source <- ggplot(metadata, aes(time_from_baseline, LIB_ID, group = LIB_ID, color = source, shape = data_type)) + 
  geom_line(color = "grey", size = 1) +  # Line color remains grey
  geom_point(size = 4, stroke = 1.5) +   # Smaller points
  ggtitle("HBOC: Overview of Cancer Status, History, and Sequencing Availability") +
  xlab("Months from Baseline") +
  ylab("Patient") +
  labs(
    color = "Group",  # Legend title for source
    shape = "Sequencing Type Available"
  ) +
  scale_color_manual(
    values = c(
      "cancer_status_negative_survivor_yes" = "#1f77b4",
      "cancer_status_negative_survivor_no" = "#9467bd",
      "cancer_status_positive_survivor_yes" = "#f4c842",
      "first_positive_survivor_no" = "#f87544"
    ),
    labels = c(
      "cancer_status_negative_survivor_yes" = "Cancer Negative (Survivor Yes)",
      "cancer_status_negative_survivor_no" = "Cancer Negative (Survivor No)",
      "cancer_status_positive_survivor_yes" = "Cancer Positive (Survivor Yes)",
      "first_positive_survivor_no" = "Cancer Positive (First Positive)"
    )
  ) +
  scale_shape_manual(values = c(16, 0, 4)) +  # Custom shapes for data_type
  facet_grid(converter ~ ., scales = "free_y", space = "free_y") +
  theme
plot_pheno_source
```

```{r}

# Save plot with reduced dimensions
ggsave(file.path(outdir, "02_figure_cohort_timelines_by_converters_and_source.pdf"), 
       plot_pheno_source, width = 20, height = 20)
```

```{r}
# Combine the plots side by side
combined_plot_cohort <- plot_grid(plot_pheno_status, plot_pheno_source, ncol = 2, align = "hv", axis = "tb", rel_widths = c(1,1))
```

```{r}
# Save the combined plot
ggsave(file.path(outdir, "02_figure_cohort_timelines_combined_plots.pdf"), combined_plot_cohort, width = 30, height = 20)
```
